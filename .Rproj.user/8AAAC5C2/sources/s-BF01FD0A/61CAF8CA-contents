


source('test-setup_report_tests.R')


sample_bexar_pdf_report <- ElectionReport_BexarPDF$new(sample_row)

test_that("Bexar PDF init", {
    expect_equal(sample_bexar_pdf_report$description, 'sample description')
    expect_equal(sample_bexar_pdf_report$date, mdy('August-3-2021'))
    expect_equal(sample_bexar_pdf_report$election_type, 'sample election type')
    expect_equal(sample_bexar_pdf_report$county, 'sample county')
    expect_equal(sample_bexar_pdf_report$report_type, 'sample report type')
    expect_equal(sample_bexar_pdf_report$url, 'sample url')
})

# Make sure it inherited file_path function correctly
test_that("Bexar PDF file_path function", {
    expect_equal(sample_bexar_pdf_report$get_file_path(), 'data/election_reports/sample description 2021-08-03.pdf')
})




###################################
#  LINE CATEGORIZATION FUNCTIONS  #
###################################


test_that("Bexar PDF is_col_name function", {
    # Cases for 1st line of column names
    expect_equal(sample_bexar_pdf_report$is_col_name("TOTAL VOTE Election Absentee Early"), TRUE)
    expect_equal(sample_bexar_pdf_report$is_col_name("   TOTAL      VOTE        Election      Absentee       Early   "), TRUE)
    expect_equal(sample_bexar_pdf_report$is_col_name("TOTAL"), FALSE)
    
    # Cases for 2nd line of column names
    expect_equal(sample_bexar_pdf_report$is_col_name("  Day  Voting "), TRUE)
    expect_equal(sample_bexar_pdf_report$is_col_name("        Day           Voting        "), TRUE)
    expect_equal(sample_bexar_pdf_report$is_col_name("Day Voting"), FALSE)
})


test_that("Bexar PDF is_vote_for function", {
    expect_equal(sample_bexar_pdf_report$is_vote_for('Vote For 1'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_vote_for('Vote For 20'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_vote_for('    Vote     for      1'), FALSE)
    expect_equal(sample_bexar_pdf_report$is_vote_for('Vote For Pedro'), FALSE)
    expect_equal(sample_bexar_pdf_report$is_vote_for('vote for 1'), FALSE)
})


test_that("Bexar PDF is_header_footer function", {
    
    # Cases for Date on 3nd line of page
    expect_equal(sample_bexar_pdf_report$is_header_footer('   September 3, 2019   '), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('May 30, 2020'), TRUE)
    
    # Cases for 1st line of each page
    expect_equal(sample_bexar_pdf_report$is_header_footer('OFFICIAL RESULTS'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('Summary Results Report           OFFICIAL RESULTS'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('OFFICIAL RESULTS '), FALSE)
    
    # Cases for election description on 2nd line of each page
    expect_equal(sample_bexar_pdf_report$is_header_footer(' Election'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('Joint General, Special, Charter and Bond Election'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('  ejs  sfo36l%%jf24lj Election'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer(' Election '), FALSE)
    
    # Cases for page number line in footer - 2nd to last line of page
    expect_equal(sample_bexar_pdf_report$is_header_footer('  Summary 3 of 39  '), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('Precinct Summary - 11/14/2020 11:23 AM        2 of 4,494'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('Summary 3  of  39'), FALSE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('Summary 1 of all'), FALSE)
    
    # Cases for last line of each page
    expect_equal(sample_bexar_pdf_report$is_header_footer('Report generated with lots of monkeys on typewriters'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('     Report generated with     spaces     before/after   keywords'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('Report    generated    with   spaces   between   keywords'), FALSE)
})


test_that("Bexar PDF is_blank function", {
    expect_equal(sample_bexar_pdf_report$is_blank(''), TRUE)
    expect_equal(sample_bexar_pdf_report$is_blank('   '), TRUE)
    expect_equal(sample_bexar_pdf_report$is_blank('e'), FALSE)
})


test_that("Bexar PDF is_useless_line function", {
    # values that would pass is_header_footer_test
    expect_equal(sample_bexar_pdf_report$is_useless_line('OFFICIAL RESULTS'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_useless_line('May 30, 2020'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_header_footer('Joint General, Special, Charter and Bond Election'), TRUE)
    
    # values that would pass is_col_name test
    expect_equal(sample_bexar_pdf_report$is_useless_line('TOTAL VOTE Election Absentee Early'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_useless_line('  Day  Voting '), TRUE)
    
    expect_equal(sample_bexar_pdf_report$is_useless_line(''), TRUE)             # value that would pass is_blank test
    expect_equal(sample_bexar_pdf_report$is_useless_line('Vote For 1'), TRUE)   # value that would pass is_vote_for test
    
    # Sample 'result' values
    expect_equal(sample_bexar_pdf_report$is_useless_line('James "Jim" Wright 113 21.40% 13 13 87'), FALSE)
    expect_equal(sample_bexar_pdf_report$is_useless_line('Total Votes Cast        528     100.00%      36     84     408'), FALSE)
    
    # Sample 'precinct' values
    expect_equal(sample_bexar_pdf_report$is_useless_line('1001'), FALSE)
    
    # Sample 'office' values
    expect_equal(sample_bexar_pdf_report$is_useless_line('Chief Justice, Supreme Court'), FALSE)
    expect_equal(sample_bexar_pdf_report$is_useless_line('President and Vice President'), FALSE)
    expect_equal(sample_bexar_pdf_report$is_useless_line('State Senator, District 26'), FALSE)

})


test_that("Bexar PDF is_result function", {
    # Random results lines from the reports
    expect_equal(sample_bexar_pdf_report$is_result('James "Jim" Wright 113 21.40% 13 13 87'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_result('Total Votes Cast     528     100.00%     36   84   408'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_result('Gabriel Lara    167       36.07%  25   19    123'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_result('AGAINST   107   24.88%   16   12   79'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_result('Undervotes   45   8   8   29'), TRUE)
    
    expect_equal(sample_bexar_pdf_report$is_result('1001'), FALSE)                          # precinct value
    expect_equal(sample_bexar_pdf_report$is_result('State Senator, District 26'), FALSE)    # office value
    expect_equal(sample_bexar_pdf_report$is_result('May 30, 2020'), FALSE)                  # header value with some numbers
    expect_equal(sample_bexar_pdf_report$is_result('Precinct Summary - 11/14/2020 11:23 AM      2 of 4,494'), FALSE) # footer value with some numbers
    
})


test_that("Bexar PDF is_precinct function", {
    expect_equal(sample_bexar_pdf_report$is_precinct('1001'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_precinct('9999'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_precinct('10 01'), FALSE)
    expect_equal(sample_bexar_pdf_report$is_precinct('1001 BS 1'), FALSE)   # This is sometimes present in other versions of the election reports
})


test_that("Bexar PDF is_office function", {
    # Sample office values
    expect_equal(sample_bexar_pdf_report$is_office('Chief Justice, Supreme Court'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_office('President and Vice President'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_office('State Senator, District 26'), TRUE)
    expect_equal(sample_bexar_pdf_report$is_office('CITY OF SAN ANTONIO - PROPOSITION A'), TRUE)
    
    expect_equal(sample_bexar_pdf_report$is_office('1001'), FALSE)  # precinct value
    expect_equal(sample_bexar_pdf_report$is_office('James "Jim" Wright      113  21.40%   13   13   87'), FALSE) # results value
    expect_equal(sample_bexar_pdf_report$is_office('May 30, 2020'), FALSE)  # header value 
    expect_equal(sample_bexar_pdf_report$is_office('Precinct Summary - 11/14/2020 11:23 AM      2 of 4,494'), FALSE) # footer value 
    expect_equal(sample_bexar_pdf_report$is_office("TOTAL VOTE Election Absentee Early"), FALSE) # col_name value
    
})


# TODO: write test to read in shortened pdf file, located at 'tests/data/bexar_pdf.pdf'
# Will not do test for downloading file at the moment.
